version: 2.1
orbs:
  aws-white-list-circleci-ip: configure/aws-white-list-circleci-ip@1.0.1
jobs:
  test:
    working_directory: ~/go/src/DerHabicht/rose-park-api
    docker:
      - image: weblair/lair:0.5.4
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "go.sum" }}
      - run:
          name: 'Start Postgres'
          command: 'service postgresql start'
      - run:
          name: 'Run tests'
          command: 'make test'
      - save_cache:
          key: dependency-cache-{{ checksum "go.sum" }}
          paths:
            - ./vendor
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: 'Login to Dockerhub'
          command: 'echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USER --password-stdin'
      - run:
          name: 'Build Docker image'
          command: 'docker build -t derhabicht/rose-park:$CIRCLE_BRANCH .'
      - run:
          name: 'Push image to Dockerhub'
          command: 'docker push derhabicht/rose-park:$CIRCLE_BRANCH'
  stage:
    working_directory: ~/go/src/DerHabicht/rose-park-api
    docker:
      - image: weblair/lair:0.5.4
    steps:
      - checkout
      # Migrate database
      - aws-white-list-circleci-ip/add:
          port: 5432
          tag-key: Name
          tag-value: 'RoseParkStage'
      - run:
          name: 'Set Lair parameters to the stage database'
          command: |
            export DB_HOST=$STAGE_DB_HOST
            export DB_NAME=$STAGE_DB_NAME
            export DB_USER=$STAGE_DB_USER
            export DB_PASSWORD=$STAGE_DB_PASSWORD
            export MIGRATIONS_DIRECTORY "database/migrations"
      - run:
          name: 'Execute migrations with Lair'
          command: lair migrate
      - aws-white-list-circleci-ip/remove:
          port: 5432
          tag-key: Name
          tag-value: 'RoseParkStage'
      # Stage A Deploy
      ## The '|| echo egal' construct on the next two steps should keep the job from failing on those steps.
      - run:
          name: 'Shut down existing service on Stage A'
          command: 'ssh ec2-user@$EC2_STAGE_A "podman stop rp-stage || echo egal"'
      - run:
          name: 'Remove Stage A Container'
          command: 'ssh ec2-user@$EC2_STAGE_A "podman rm rp-stage || echo egal"'
      - run:
          name: 'Pull Stage A Container'
          command: 'ssh ec2-user@$EC2_STAGE_A "podman pull derhabicht/rose-park:$CIRCLE_BRANCH"'
      - run:
          name: 'Start Stage A Container'
          command: |
            ssh ec2-user@$EC2_STAGE_A \
              "podman run -d --name rp-stage \
              --publish 8080:8080 \
              --env DB_HOST=$STAGE_DB_HOST \
              --env DB_USER=$STAGE_DB_USER \
              --env DB_NAME=$STAGE_DB_NAME \
              --env DB_PASSWORD=$STAGE_DB_PASSWORD \
              --env AUTH0_API_AUDIENCE=$AUTH0_API_AUDIENCE \
              --env AUTH0_JWK=$AUTH0_JWK \
              derhabicht/rose-park:$CIRCLE_BRANCH"
      # Stage B Deploy
      ## The '|| echo egal' construct on the next two steps should keep the job from failing on those steps.
      - run:
          name: 'Shut down existing service on Stage B'
          command: 'ssh ec2-user@$EC2_STAGE_B "podman stop rp-stage || echo egal"'
      - run:
          name: 'Remove Stage B Container'
          command: 'ssh ec2-user@$EC2_STAGE_B "podman rm rp-stage || echo egal"'
      - run:
          name: 'Pull Stage B Container'
          command: 'ssh ec2-user@$EC2_STAGE_B "podman pull derhabicht/rose-park:$CIRCLE_BRANCH"'
      - run:
          name: 'Start Stage B Container'
          command: |
            ssh ec2-user@$EC2_STAGE_B \
              "podman run -d --name rp-stage \
              --publish 8080:8080 \
              --env DB_HOST=$STAGE_DB_HOST \
              --env DB_USER=$STAGE_DB_USER \
              --env DB_NAME=$STAGE_DB_NAME \
              --env DB_PASSWORD=$STAGE_DB_PASSWORD \
              --env AUTH0_API_AUDIENCE=$AUTH0_API_AUDIENCE \
              --env AUTH0_JWK=$AUTH0_JWK \
              derhabicht/rose-park:$CIRCLE_BRANCH"

workflows:
  version: 2
  test-deploy:
    jobs:
      - test
      - build:
          requires:
            - test
          filters:
            branches:
              only:
                - develop
                - master
                - ci
      - stage:
          context: aws-thus
          requires:
            - build
          filters:
            branches:
              only:
                - develop
                - ci
#      - stage-test:
#        requires:
#          - stage
#        filters:
#          branches:
#            only: develop
#      - deploy:
#          context: rose-park
#          requires:
#            - build
#          filters:
#            branches:
#              only: master
